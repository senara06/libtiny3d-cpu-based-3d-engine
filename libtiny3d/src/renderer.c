#include <math.h>
#include "renderer.h"
#include "math3d.h"


// Cube: 8 vertices, 12 edges
const vec3_t cube_vertices[8] = {
    {-1, -1, -1}, {1, -1, -1},
    {1,  1, -1}, {-1, 1, -1},
    {-1, -1,  1}, {1, -1,  1},
    {1,  1,  1}, {-1, 1,  1}
};

const int cube_edges[12][2] = {
    {0,1}, {1,2}, {2,3}, {3,0},
    {4,5}, {5,6}, {6,7}, {7,4},
    {0,4}, {1,5}, {2,6}, {3,7}
};

// Soccer ball: 60 vertices
const vec3_t soccer_vertices[60] = {
    {0.500000f, 0.000000f, 2.427051f},     {0.500000f, 0.000000f, -2.427051f},
    {-0.500000f, 0.000000f, 2.427051f},    {-0.500000f, 0.000000f, -2.427051f},
    {2.427051f, 0.500000f, 0.000000f},     {2.427051f, -0.500000f, 0.000000f},
    {-2.427051f, 0.500000f, 0.000000f},    {-2.427051f, -0.500000f, 0.000000f},
    {0.000000f, 2.427051f, 0.500000f},     {0.000000f, 2.427051f, -0.500000f},
    {0.000000f, -2.427051f, 0.500000f},    {0.000000f, -2.427051f, -0.500000f},
    {1.000000f, 0.809017f, 2.118034f},     {1.000000f, 0.809017f, -2.118034f},
    {1.000000f, -0.809017f, 2.118034f},    {1.000000f, -0.809017f, -2.118034f},
    {-1.000000f, 0.809017f, 2.118034f},    {-1.000000f, 0.809017f, -2.118034f},
    {-1.000000f, -0.809017f, 2.118034f},   {-1.000000f, -0.809017f, -2.118034f},
    {2.118034f, 1.000000f, 0.809017f},     {2.118034f, 1.000000f, -0.809017f},
    {2.118034f, -1.000000f, 0.809017f},    {2.118034f, -1.000000f, -0.809017f},
    {-2.118034f, 1.000000f, 0.809017f},    {-2.118034f, 1.000000f, -0.809017f},
    {-2.118034f, -1.000000f, 0.809017f},   {-2.118034f, -1.000000f, -0.809017f},
    {0.809017f, 2.118034f, 1.000000f},     {0.809017f, 2.118034f, -1.000000f},
    {0.809017f, -2.118034f, 1.000000f},    {0.809017f, -2.118034f, -1.000000f},
    {-0.809017f, 2.118034f, 1.000000f},    {-0.809017f, 2.118034f, -1.000000f},
    {-0.809017f, -2.118034f, 1.000000f},   {-0.809017f, -2.118034f, -1.000000f},
    {0.500000f, 1.618034f, 1.809017f},     {0.500000f, 1.618034f, -1.809017f},
    {0.500000f, -1.618034f, 1.809017f},    {0.500000f, -1.618034f, -1.809017f},
    {-0.500000f, 1.618034f, 1.809017f},    {-0.500000f, 1.618034f, -1.809017f},
    {-0.500000f, -1.618034f, 1.809017f},   {-0.500000f, -1.618034f, -1.809017f},
    {1.809017f, 0.500000f, 1.618034f},     {1.809017f, 0.500000f, -1.618034f},
    {1.809017f, -0.500000f, 1.618034f},    {1.809017f, -0.500000f, -1.618034f},
    {-1.809017f, 0.500000f, 1.618034f},    {-1.809017f, 0.500000f, -1.618034f},
    {-1.809017f, -0.500000f, 1.618034f},   {-1.809017f, -0.500000f, -1.618034f},
    {1.618034f, 1.809017f, 0.500000f},     {1.618034f, 1.809017f, -0.500000f},
    {1.618034f, -1.809017f, 0.500000f},    {1.618034f, -1.809017f, -0.500000f},
    {-1.618034f, 1.809017f, 0.500000f},    {-1.618034f, 1.809017f, -0.500000f},
    {-1.618034f, -1.809017f, 0.500000f},   {-1.618034f, -1.809017f, -0.500000f}
};

// Soccer ball: 90 edges
const int soccer_edges[90][2] = {
    {0, 2}, {0, 12}, {0, 14}, {1, 3}, {1, 13}, {1, 15}, {2, 16}, {2, 18},
    {3, 17}, {3, 19}, {4, 5}, {4, 20}, {4, 21}, {5, 22}, {5, 23}, {6, 7},
    {6, 24}, {6, 25}, {7, 26}, {7, 27}, {8, 9}, {8, 28}, {8, 32}, {9, 29},
    {9, 33}, {10, 11}, {10, 30}, {10, 34}, {11, 31}, {11, 35}, {12, 36},
    {12, 44}, {13, 37}, {13, 45}, {14, 38}, {14, 46}, {15, 39}, {15, 47},
    {16, 40}, {16, 48}, {17, 41}, {17, 49}, {18, 42}, {18, 50}, {19, 43},
    {19, 51}, {20, 44}, {20, 52}, {21, 45}, {21, 53}, {22, 46}, {22, 54},
    {23, 47}, {23, 55}, {24, 48}, {24, 56}, {25, 49}, {25, 57}, {26, 50},
    {26, 58}, {27, 51}, {27, 59}, {28, 36}, {28, 52}, {29, 37}, {29, 53},
    {30, 38}, {30, 54}, {31, 39}, {31, 55}, {32, 40}, {32, 56}, {33, 41},
    {33, 57}, {34, 42}, {34, 58}, {35, 43}, {35, 59}, {36, 40}, {37, 41},
    {38, 42}, {39, 43}, {44, 46}, {45, 47}, {48, 50}, {49, 51}, {52, 53},
    {54, 55}, {58, 59}
};

int inside_circle(float x, float y, float cx, float cy, float r) {
    float dx = x - cx, dy = y - cy;
    return (dx * dx + dy * dy) <= (r * r);
}

// --- Lambertian Lighting Wireframe Renderer ---
void render_wireframe(
    canvas_t* canvas,
    const vec3_t* vertices,
    const int edges[][2],
    int num_vertices,
    int num_edges,
    mat4_t transform,
    float center_x,
    float center_y,
    float scale,
    float radius,
    vec3_t light_pos // NEW: 3D light position
) {
    float proj_x[64], proj_y[64];
    vec3_t world_pos[64];
    for (int i = 0; i < num_vertices; ++i) {
        vec3_t r = mat4_mul_vec3(transform, vertices[i]);
        proj_x[i] = center_x + r.x * scale;
        proj_y[i] = center_y - r.y * scale;
        world_pos[i] = r;
    }
    for (int i = 0; i < num_edges; ++i) {
        int a = edges[i][0], b = edges[i][1];
        if (inside_circle(proj_x[a], proj_y[a], center_x, center_y, radius) &&
            inside_circle(proj_x[b], proj_y[b], center_x, center_y, radius)) {

            // Lighting calculation
            vec3_t pa = world_pos[a];
            vec3_t pb = world_pos[b];
            vec3_t edge_dir = vec3_normalize(vec3_sub(pb, pa));
            vec3_t edge_mid = vec3_scale(vec3_add(pa, pb), 0.5f);
            vec3_t light_dir = vec3_normalize(vec3_sub(light_pos, edge_mid));
            float intensity = fmaxf(0.2f, fmaxf(0.0f, vec3_dot(edge_dir, light_dir)));

            draw_line_f_intensity(canvas, proj_x[a], proj_y[a], proj_x[b], proj_y[b], 2.0f, intensity);
        }
    }
}
